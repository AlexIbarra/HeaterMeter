<%+header%>
<h2>LinkMeter Database Archives</h2>
<h3>Stash (archive) database</h3>
<form method="GET" action="<%=luci.dispatcher.build_url("admin","lm","stashdb")%>">
  Filename: <input name="rrd" type="text" value="<%=os.date("%Y-%m-%d")%>" />
  <input type="submit" value="Stash" />
</form>
<% 
  local uci = luci.model.uci.cursor()
  local STASH_PATH = uci:get("linkmeter", "daemon", "stashpath")
%>
  <h3>Stored in <%=STASH_PATH%></h3>
  
  <table style="border-spacing: 40px 4px; width: 50%;">
    <tr><th style="border: 1px solid #ddd;">View</th><th style="border: 1px solid #ddd;">Name</th></tr>
<% 
local files = {}
for fn in nixio.fs.dir(STASH_PATH) do 
  local f = {}
  f.name = fn
  f.path = STASH_PATH .. "/" .. fn
  f.stat = nixio.fs.stat(f.path)
  if f.stat.type == "reg" then
    files[#files+1] = f
  end
end

table.sort(files, function(a,b) return a.stat.mtime < b.stat.mtime end )

for _,f in ipairs(files) do
    local urlView = luci.dispatcher.build_url("lm").."?rrd="..f.path
    local urlCsv = luci.dispatcher.build_url("lm","hist").."?rrd="..f.path
%>
    <tr>
      <td>
        <a href="<%=urlView%>"><img src="<%=resource.."/chart_curve.png"%>" />View</a>
        <a href="<%=urlCsv%>"><img src="<%=resource.."/table_go.png"%>" />CSV</a>
      </td>
      <td>
        <div style="color: #999; font-style: italic; font-size: smaller;"><%=os.date("%B %d, %Y  %I:%M%p", f.stat.mtime)%></div>
        <div style="font-size: large;"><%=f.name%></div>
      </td>
    </tr>
    <tr><td colspan="2" style="background: #ccc; height: 2px;"></td></tr>
<% end %>
  </table>
<%+footer%>

